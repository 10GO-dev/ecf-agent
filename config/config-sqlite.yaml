# Configuración del Agente ECF - SQLite (Para pruebas locales)
# 
# Usar con la estructura real del cliente (basado en script.sql)
# 
# Para crear la BD de prueba:
#   python scripts/setup_test_db.py
#
# Para ejecutar:
#   python -m src.main run --config config/config-sqlite.yaml

agent:
  # RNC del cliente (emisor de los comprobantes)
  customer_rnc: "130013454"
  
  # Intervalo de polling a la base de datos (segundos)
  polling_interval_seconds: 10
  
  # Máximo de facturas por request al API
  batch_size: 10
  
  # Intervalo de reintento para facturas fallidas (segundos)
  retry_interval_seconds: 60
  
  # Máximo de reintentos antes de marcar como fallida
  max_retries: 3

# Conexión a la API de TekServices (local)
api:
  base_url: "http://localhost:3030"
  endpoint: "/private/ecf/invoices"
  
  # Autenticación por API Key (desde .env)
  api_key: "${ECF_API_KEY}"
  
  # Timeout para requests HTTP (segundos)
  timeout_seconds: 30
  
  # Método de compresión: "zstd" | "gzip" | "none"
  # zstd = MessagePack + zstd + base64 (optimizado, rápido) [DEFAULT]
  # gzip = JSON + gzip + base64 (compatible, estándar)
  # Para usar zstd: pip install msgpack zstandard
  compression: "zstd"

# Conexión a SQLite de prueba
database:
  driver: "sqlite"
  database: "./data/test_invoices.db"
  
  # Standard query for headers
  query: |
    SELECT *,
           transaccionid as id,
           encf as ecf_number,
           tipoecf as ecf_type,
           RNCComprador as rnc_buyer,
           MontoTotal as total_amount
    FROM interfazencf
    WHERE estado = 'A'
    ORDER BY transaccionid ASC
    LIMIT {batch_size}

  # Subqueries para extraccion DB-Agnostic
  details_query: |
    SELECT * 
    FROM interfazencfdet 
    WHERE transaccionid IN ({ids})
  
  taxes_query: |
    SELECT * 
    FROM ecftipoimpadic 
    WHERE transaccionid IN ({ids})
    
  payments_query: |
    SELECT * 
    FROM ecfformapago 
    WHERE transaccionid IN ({ids})
  

  # Campos de metadatos
  id_field: "id"
  ecf_field: "ecf_number"
  type_field: "ecf_type"
  rnc_buyer_field: "rnc_buyer"
  total_field: "total_amount"
  
  # Query para marcar como procesada (estado: A=Activo, P=Procesado)
  update_query: |
    UPDATE interfazencf 
    SET estado = 'P' 
    WHERE transaccionid = {id}

# Cola de reintentos
queue:
  db_path: "./data/retry_queue.db"

# Configuración de logs
logging:
  level: "DEBUG"
  file: "./logs/ecf-agent-test.log"
  max_size_mb: 5
  backup_count: 3
  console: true
