# Configuración del Agente ECF
# Copiar este archivo a config.yaml y ajustar valores

agent:
  # RNC del cliente (emisor de los comprobantes)
  customer_rnc: "101010101"
  
  # Intervalo de polling a la base de datos (segundos)
  polling_interval_seconds: 30
  
  # Intervalo de sincronización de estados pendientes con el backend (segundos)
  status_sync_interval_seconds: 300
  
  # Máximo de facturas por request al API
  batch_size: 50
  
  # Intervalo de reintento para facturas fallidas (segundos)
  retry_interval_seconds: 300
  
  # Máximo de reintentos antes de marcar como fallida
  max_retries: 5

# Conexión a la API de TekServices
api:
  base_url: "https://tekservices.com.do"
  endpoint: "/private/ecf/dgii-send"
  
  # Autenticación por API Key (usar variables de entorno)
  api_key: "${ECF_API_KEY}"
  
  # Timeout para requests HTTP (segundos)
  timeout_seconds: 30
  
  # Método de compresión: "zstd" | "gzip" | "none"
  # zstd = MessagePack + zstd + base64 (optimizado, rápido) [DEFAULT]
  # gzip = JSON + gzip + base64 (compatible, estándar)
  # Para usar zstd: pip install msgpack zstandard
  compression: "zstd"

# Conexión a la base de datos del cliente
database:
  # Driver: mysql | postgres | sqlserver | oracle
  driver: "mysql"
  
  host: "localhost"
  port: 3306
  database: "facturacion"
  username: "ecf_reader"
  password: "${DB_PASSWORD}"
  
  # ============================================================
  # EXTRACTOR DB-AGNOSTICO
  # ============================================================
  # Configura las 4 queries necesarias para extraer las facturas.
  # El Agente se encargará de ensamblar el JSON internamente.
  #
  # Variables disponibles:
  #   - {batch_size}: En 'query' (cabeceras)
  #   - {ids}: En las subqueries, los IDs base retornados por 'query'
  # ============================================================
  
  query: |
    SELECT 
        e.transaccionid as id,
        e.encf as ecf_number,
        e.tipoecf as ecf_type,
        e.RNCComprador as rnc_buyer,
        e.MontoTotal as total_amount,
        e.*
    FROM interfazencf e
    WHERE e.procesadadgii = 'N' AND e.estado = 'A'
    ORDER BY e.transaccionid ASC
    LIMIT {batch_size}
  
  details_query: |
    SELECT * 
    FROM interfazencfdet 
    WHERE transaccionid IN ({ids})
  
  taxes_query: |
    SELECT * 
    FROM ecftipoimpadic 
    WHERE transaccionid IN ({ids})
    
  payments_query: |
    SELECT * 
    FROM ecfformapago 
    WHERE transaccionid IN ({ids})
  
  # Campo ID único de la factura
  id_field: "id"
  
  # Campo e-NCF
  ecf_field: "ecf_number"
  
  # Campo tipo de comprobante
  type_field: "ecf_type"
  
  # Campo RNC comprador
  rnc_buyer_field: "rnc_buyer"
  
  # Campo monto total
  total_field: "total_amount"
  
  # Query para marcar como procesada
  # Variables disponibles: {id}
  update_query: |
    UPDATE interfazencf 
    SET procesadadgii = 'S', 
        fecha_procesada = NOW() 
    WHERE transaccionid = {id}

  # ============================================================
  # QUERIES PARA SINCRONIZACIÓN DE ESTADOS (Fallback)
  # ============================================================
  # Query para obtener facturas que se enviaron pero están pendientes de estado DGII
  pending_status_query: |
    SELECT 
      encf
    FROM interfazencf 
    WHERE procesadadgii = 'S' AND (estado = 'P' OR estado = '')
    LIMIT {batch_size}

  # Query para actualizar el estado cuando el backend responde
  # Parámetros disponibles: {ecf}, {status}, {track_id}
  # Nota: Hemos acordado temporalmente NO guardar el track_id en el ERP,
  # por lo que solo actualizamos el estado.
  # Parámetros disponibles: {ecf}, {status}, {track_id}, {error} (solo usar columnas existentes)
  update_status_query: |
    UPDATE interfazencf 
    SET 
      estado = '{status}'
    WHERE encf = '{ecf}'

# Configuración de logs
logging:
  # Nivel: DEBUG, INFO, WARNING, ERROR
  level: "INFO"
  
  # Archivo de log
  file: "./logs/ecf-agent.log"
  
  # Tamaño máximo del archivo (MB)
  max_size_mb: 10
  
  # Cantidad de archivos de backup a mantener
  backup_count: 5
  
  # Mostrar en consola
  console: true
