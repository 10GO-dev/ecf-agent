# Configuración del Agente ECF - SQLite (Para pruebas locales)
# 
# Usar con la estructura real del cliente (basado en script.sql)
# 
# Para crear la BD de prueba:
#   python scripts/setup_test_db.py
#
# Para ejecutar:
#   python -m src.main run --config config/config-sqlite.yaml

agent:
  # RNC del cliente (emisor de los comprobantes)
  customer_rnc: "130013454"
  
  # Intervalo de polling a la base de datos (segundos)
  polling_interval_seconds: 10
  
  # Máximo de facturas por request al API
  batch_size: 10
  
  # Intervalo de reintento para facturas fallidas (segundos)
  retry_interval_seconds: 60
  
  # Máximo de reintentos antes de marcar como fallida
  max_retries: 3

# Conexión a la API de TekServices (local)
api:
  base_url: "http://localhost:3030"
  endpoint: "/private/ecf/invoices"
  
  # Autenticación por API Key (desde .env)
  api_key: "${ECF_API_KEY}"
  
  # Timeout para requests HTTP (segundos)
  timeout_seconds: 30
  
  # Método de compresión: "zstd" | "gzip" | "none"
  # zstd = MessagePack + zstd + base64 (optimizado, rápido) [DEFAULT]
  # gzip = JSON + gzip + base64 (compatible, estándar)
  # Para usar zstd: pip install msgpack zstandard
  compression: "zstd"

# Conexión a SQLite de prueba
database:
  driver: "sqlite"
  database: "./data/test_invoices.db"
  
  # Query que genera JSON con estructura factura_db compatible
  # Nota: SQLite usa json_object() y json_group_array() (requiere SQLite 3.38+)
  query: |
    SELECT 
        e.transaccionid as id,
        e.encf as ecf_number,
        e.tipoecf as ecf_type,
        e.RNCComprador as rnc_buyer,
        e.MontoTotal as total_amount,
        json_object(
                'transaccionid', e.transaccionid,
                'codalmacen', e.codalmacen,
                'tipoecf', e.tipoecf,
                'encf', e.encf,
                'FechaVencimientoSecuencia', e.FechaVencimientoSecuencia,
                'IndicadorNotaCredito', e.IndicadorNotaCredito,
                'IndicadorEnvioDiferido', e.IndicadorEnvioDiferido,
                'IndicadorMontoGravado', e.IndicadorMontoGravado,
                'TipoIngresos', e.TipoIngresos,
                'TipoPago', e.TipoPago,
                'FechaLimitePago', e.FechaLimitePago,
                'Terminopago', e.Terminopago,
                'MontoPago', e.MontoPago,
                'TipoCuentaPago', e.TipoCuentaPago,
                'NumeroCuentaPago', e.NumeroCuentaPago,
                'BancoPago', e.BancoPago,
                'FechaDesde', e.FechaDesde,
                'FechaHasta', e.FechaHasta,
                'TotalPaginas', e.TotalPaginas,
                'RNCEmisor', e.RNCEmisor,
                'RazonSocialEmisor', e.RazonSocialEmisor,
                'NombreComercial', e.NombreComercial,
                'Sucursal', e.Sucursal,
                'DireccionEmisor', e.DireccionEmisor,
                'Municipioemisor', e.Municipioemisor,
                'Provincia', e.Provincia,
                'TelefonoEmisor', e.TelefonoEmisor,
                'CorreoEmisor', e.CorreoEmisor,
                'WebSite', e.WebSite,
                'ActividadEconomica', e.ActividadEconomica,
                'CodigoVendedor', e.CodigoVendedor,
                'NumeroFacturaInterna', e.NumeroFacturaInterna,
                'NumeroPedidoInterno', e.NumeroPedidoInterno,
                'ZonaVenta', e.ZonaVenta,
                'RutaVenta', e.RutaVenta,
                'FechaEmision', e.FechaEmision,
                'RNCComprador', e.RNCComprador,
                'IdentificadorExtranjero', e.IdentificadorExtranjero,
                'RazonSocialComprador', e.RazonSocialComprador,
                'ContactoComprador', e.ContactoComprador,
                'CorreoComprador', e.CorreoComprador,
                'DireccionComprador', e.DireccionComprador,
                'MunicipioComprador', e.MunicipioComprador,
                'ProvinciaComprador', e.ProvinciaComprador,
                'PaisComprador', e.PaisComprador,
                'FechaEntrega', e.FechaEntrega,
                'ContactoEntrega', e.ContactoEntrega,
                'DireccionEntrega', e.DireccionEntrega,
                'TelefonoAdicionalcomprador', e.TelefonoAdicionalcomprador,
                'FechaOrdenCompra', e.FechaOrdenCompra,
                'NumeroOrdenCompra', e.NumeroOrdenCompra,
                'CodigoInternoComprador', e.CodigoInternoComprador,
                'ResponsablePago', e.ResponsablePago,
                'MontoGravadoTotal', e.MontoGravadoTotal,
                'MontoGravadoI1', e.MontoGravadoI1,
                'MontoGravadoI2', e.MontoGravadoI2,
                'MontoGravadoI3', e.MontoGravadoI3,
                'MontoExento', e.MontoExento,
                'Itbistasa1', e.Itbistasa1,
                'Itbistasa2', e.Itbistasa2,
                'Itbistasa3', e.Itbistasa3,
                'TotalITBIS', e.TotalITBIS,
                'TotalITBIS1', e.TotalITBIS1,
                'TotalITBIS2', e.TotalITBIS2,
                'TotalITBIS3', e.TotalITBIS3,
                'MontoImpuestoAdicional', e.MontoImpuestoAdicional,
                'MontoTotal', e.MontoTotal,
                'MontoNoFacturable', e.MontoNoFacturable,
                'MontoPeriodo', e.MontoPeriodo,
                'SaldoAnterior', e.SaldoAnterior,
                'MontoAvancePago', e.MontoAvancePago,
                'ValorPagar', e.ValorPagar,
                'TotalITBISRetenido', e.TotalITBISRetenido,
                'TotalISRRetencion', e.TotalISRRetencion,
                'TotalITBISPercepcion', e.TotalITBISPercepcion,
                'TotalISRPercepcion', e.TotalISRPercepcion,
                'TipoMoneda', e.TipoMoneda,
                'TipoCambio', e.TipoCambio,
                'MontoGravadoTotalOtraMoneda', e.MontoGravadoTotalOtraMoneda,
                'MontoGravado1OtraMoneda', e.MontoGravado1OtraMoneda,
                'MontoGravado2OtraMoneda', e.MontoGravado2OtraMoneda,
                'MontoGravado3OtraMoneda', e.MontoGravado3OtraMoneda,
                'MontoExentoOtraMoneda', e.MontoExentoOtraMoneda,
                'TotalITBISOtraMoneda', e.TotalITBISOtraMoneda,
                'TotalITBIS1OtraMoneda', e.TotalITBIS1OtraMoneda,
                'TotalITBIS2OtraMoneda', e.TotalITBIS2OtraMoneda,
                'TotalITBIS3OtraMoneda', e.TotalITBIS3OtraMoneda,
                'MontoImpuestoAdicionalOtraMoneda', e.MontoImpuestoAdicionalOtraMoneda,
                'TotalotraMoneda', e.TotalotraMoneda,
                'estado', e.estado,
                'procesadadgii', e.procesadadgii,
                'ImpuestosAdicionales', 
                (SELECT json_group_array(objeto)
                FROM (
                    SELECT DISTINCT
                        json_object(
                            'tipoimpid', i.tipoimpid,
                            'codimp', i.codimp,
                            'tasaimp', i.tasaimp
                        ) AS objeto
                    FROM ecftipoimpadic i
                    WHERE i.transaccionid = e.transaccionid
                    AND i.codalmacen = e.codalmacen
                ) AS t),

                'Detalles', (
                    SELECT json_group_array(
                    json_object(
                        'linea', d.linea,
                        'NumeroLinea', d.NumeroLinea,
                        'IndicadorFacturacion', d.IndicadorFacturacion,
                        'IndicadorAgenteRetencionoPercepcion', d.IndicadorAgenteRetencionoPercepcion,
                        'MontoITBISRetenido', d.MontoITBISRetenido,
                        'MontoISRRetenido', d.MontoISRRetenido,
                        'tipoimpuesto', d.tipoimpuesto,
                        'tasaITBIS1', d.tasaITBIS1,
                        'tasaITBIS2', d.tasaITBIS2,
                        'tasaITBIS3', d.tasaITBIS3,
                        'tasaISC', d.tasaISC,
                        'tasaISCAD', d.tasaISCAD,
                        'tasaotroimp', d.tasaotroimp,
                        'MontoITBIS1', d.MontoITBIS1,
                        'MontoITBIS2', d.MontoITBIS2,
                        'MontoITBIS3', d.MontoITBIS3,
                        'MontoISC', d.MontoISC,
                        'MontoISCAd', d.MontoISCAd,
                        'MontoOtrosImp', d.MontoOtrosImp,
                        'tipoimpotramoneda', d.tipoimpotramoneda,
                        'tasaITBIS1otramoneda', d.tasaITBIS1otramoneda,
                        'tasaITBIS2otramoneda', d.tasaITBIS2otramoneda,
                        'tasaITBIS3otramoneda', d.tasaITBIS3otramoneda,
                        'tasaISCotramoneda', d.tasaISCotramoneda,
                        'tasaISCADotramoneda', d.tasaISCADotramoneda,
                        'tasaotroimpotramoneda', d.tasaotroimpotramoneda,
                        'MontoITBIS1otramoneda', d.MontoITBIS1otramoneda,
                        'MontoITBIS2otramoneda', d.MontoITBIS2otramoneda,
                        'MontoITBIS3otramoneda', d.MontoITBIS3otramoneda,
                        'MontoISCotramoneda', d.MontoISCotramoneda,
                        'MontoISCAdotramoneda', d.MontoISCAdotramoneda,
                        'MontoOtrosImpotramoneda', d.MontoOtrosImpotramoneda,
                        'TipoCodigo', d.TipoCodigo,
                        'CodigoItem', d.CodigoItem,
                        'NombreItem', d.NombreItem,
                        'IndicadorBienoServicio', d.IndicadorBienoServicio,
                        'DescripcionItem', d.DescripcionItem,
                        'CantidadItem', d.CantidadItem,
                        'UnidadMedida', d.UnidadMedida,
                        'CantidadReferencia', d.CantidadReferencia,
                        'Subcantidad', d.Subcantidad,
                        'CodigoSubCantidad', d.CodigoSubCantidad,
                        'GradosAcohol', d.GradosAcohol,
                        'PrecioUnitarioReferencia', d.PrecioUnitarioReferencia,
                        'FechaElaboracion', d.FechaElaboracion,
                        'FechaVencimientoItem', d.FechaVencimientoItem,
                        'PrecioUnitarioItem', d.PrecioUnitarioItem,
                        'DescuentoMonto', d.DescuentoMonto,
                        'PrecioOtraMoneda', d.PrecioOtraMoneda,
                        'DescuentoOtraMoneda', d.DescuentoOtraMoneda,
                        'MontoItemOtraMoneda', d.MontoItemOtraMoneda,
                        'MontoItem', d.MontoItem,
                        'NumeroSubTotal', d.NumeroSubTotal,
                        'DescripcionSubtotal', d.DescripcionSubtotal,
                        'Orden', d.Orden,
                        'SubTotalMontoGravadoTotal', d.SubTotalMontoGravadoTotal,
                        'SubTotalMontoGravadoI1', d.SubTotalMontoGravadoI1,
                        'SubTotalMontoGravadoI2', d.SubTotalMontoGravadoI2,
                        'SubTotalMontoGravadoI3', d.SubTotalMontoGravadoI3,
                        'SubTotalITBIS1', d.SubTotalITBIS1,
                        'SubTotalITBIS2', d.SubTotalITBIS2,
                        'SubTotalITBIS3', d.SubTotalITBIS3,
                        'SubTotalImpuestoAdicional', d.SubTotalImpuestoAdicional,
                        'SubTotalExento', d.SubTotalExento,
                        'MontoSubTotal', d.MontoSubTotal,
                        
                        'ImpuestosAdicionales', (
                            SELECT json_group_array(
                                json_object(
                                    'codimp', i.codimp
                                )
                            )
                            FROM ecftipoimpadic i
                            WHERE i.transaccionid = d.transaccionid
                              AND i.codalmacen = d.codalmacen
                              AND i.linea = d.linea
                        ),
                        'SubDescuentos', (
                        SELECT json_group_array(
                            json_object(
                                'subdescid', s.subdescid,
                                'tiposubdesc', s.tiposubdesc,
                                'porcentajedesc', s.porcentajedesc,
                                'montosubdesc', s.montosubdesc
                            )
                        )
                        FROM ecfsubdescuento s
                        WHERE s.transaccionid = d.transaccionid
                          AND s.codalmacen = d.codalmacen
                          AND s.linea = d.linea
                      )
                    )
                )
                FROM interfazencfdet d
                WHERE d.transaccionid = e.transaccionid AND d.codalmacen = e.codalmacen
            ),
            'FormasPago', (
                SELECT json_group_array(
                    json_object(
                        'formapagoid', f.formapagoid,
                        'formapago', f.formapago,
                        'montopago', f.montopago
                    )
                )
                FROM ecfformapago f
                WHERE f.transaccionid = e.transaccionid AND f.codalmacen = e.codalmacen
            )
        ) as invoice_json
    FROM interfazencf e
    WHERE e.estado = 'A'
    ORDER BY e.transaccionid ASC
    LIMIT {batch_size}
  
  # Campo que contiene el JSON de la factura
  json_field: "invoice_json"
  
  # Campos de metadatos
  id_field: "id"
  ecf_field: "ecf_number"
  type_field: "ecf_type"
  rnc_buyer_field: "rnc_buyer"
  total_field: "total_amount"
  
  # Query para marcar como procesada (estado: A=Activo, P=Procesado)
  update_query: |
    UPDATE interfazencf 
    SET estado = 'P' 
    WHERE transaccionid = {id}

# Cola de reintentos
queue:
  db_path: "./data/retry_queue.db"

# Configuración de logs
logging:
  level: "DEBUG"
  file: "./logs/ecf-agent-test.log"
  max_size_mb: 5
  backup_count: 3
  console: true
